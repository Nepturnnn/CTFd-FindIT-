{% extends "base.html" %}

{% block content %}
<div class="jumbotron">
  <div class="container text-center">
    <h1 class="main-title">{% trans %}Scoreboard{% endtrans %}</h1>
  </div>
</div>

<div class="container" x-data="CustomScoreboard">
  {% include "components/errors.html" %}

  <div class="row mb-4" x-show="isPreStart" x-transition>
    <div class="col-md-12 text-center">
      <div class="alert alert-info p-3" style="background: rgba(0, 255, 255, 0.1); border: 1px solid #00ffff; border-radius: 15px; color: #00ffff;">
        <i class="fas fa-info-circle me-2"></i> Match hasn't started yet. Showing registered challengers.
      </div>
    </div>
  </div>

  <div id="score-graph" class="d-flex align-items-center mb-4" x-data="ScoreboardDetail" x-ref="scoregraph" @bracket-change.window="activeBracket=$event.detail; update();">
    <div class="col-md-12 text-center">
      <i class="fas fa-circle-notch fa-spin fa-3x fa-fw spinner"></i>
    </div>
  </div>

  <div id="scoreboard" class="row">
    
    <div class="col-md-12">
      <div class="podium-flex-wrapper">
        
        <template x-if="isPreStart">
          <div class="w-100 d-flex justify-content-center podium-container">
             <div class="podium-item second-place">
                <div class="podium-card" style="opacity: 0.7;">
                  <div class="rank-badge">2</div>
                  <div class="avatar-placeholder medal-silver">
                      <i class="fas fa-medal"></i>
                  </div>
                  <div class="podium-link">
                    <h4 class="text-muted">---</h4>
                  </div>
                  <p class="points">0 pts</p>
                </div>
              </div>

              <div class="podium-item first-place">
                <div class="podium-card" style="opacity: 0.7;">
                  <div class="rank-badge">★</div>
                  <div class="avatar-placeholder medal-gold">
                      <i class="fas fa-crown"></i>
                  </div>
                  <div class="podium-link">
                    <h4 class="text-muted">---</h4>
                  </div>
                  <p class="points gold">0 pts</p>
                </div>
              </div>

              <div class="podium-item third-place">
                <div class="podium-card" style="opacity: 0.7;">
                  <div class="rank-badge">3</div>
                  <div class="avatar-placeholder medal-bronze">
                      <i class="fas fa-medal"></i>
                  </div>
                  <div class="podium-link">
                    <h4 class="text-muted">---</h4>
                  </div>
                  <p class="points">0 pts</p>
                </div>
              </div>
          </div>
        </template>

        <template x-if="!isPreStart && standings.length >= 2">
          <div class="podium-item second-place">
            <div class="podium-card">
              <div class="rank-badge">2</div>
              <div class="avatar-placeholder medal-silver">
                  <i class="fas fa-medal"></i>
              </div>
              <a :href="standings[1].account_url" class="podium-link">
                <h4 x-text="standings[1].name"></h4>
              </a>
              <p class="points" x-text="standings[1].score + ' pts'"></p>
            </div>
          </div>
        </template>

        <template x-if="!isPreStart && standings.length >= 1">
          <div class="podium-item first-place">
            <div class="podium-card">
              <div class="rank-badge">★</div>
              <div class="avatar-placeholder medal-gold">
                  <i class="fas fa-crown"></i>
              </div>
              <a :href="standings[0].account_url" class="podium-link">
                <h4 x-text="standings[0].name"></h4>
              </a>
              <p class="points gold" x-text="standings[0].score + ' pts'"></p>
            </div>
          </div>
        </template>

        <template x-if="!isPreStart && standings.length >= 3">
          <div class="podium-item third-place">
            <div class="podium-card">
              <div class="rank-badge">3</div>
              <div class="avatar-placeholder medal-bronze">
                  <i class="fas fa-medal"></i>
              </div>
              <a :href="standings[2].account_url" class="podium-link">
                <h4 x-text="standings[2].name"></h4>
              </a>
              <p class="points" x-text="standings[2].score + ' pts'"></p>
            </div>
          </div>
        </template>

      </div>
    </div>

    <div class="col-md-12" x-show="standings.length">
      <div class="table-responsive">
        <table class="table table-dark-custom">
          <thead>
            <tr>
              <th class="text-center" style="width: 80px;">Place</th>
              <th class="text-start">Team</th>
              <th class="text-center" style="width: 150px;">Score</th>
            </tr>
          </thead>
          <tbody>
            <template x-for="(standing, index) in standings" :key="index">
              <tr x-show="isPreStart || index >= 3">
                
                <th class="text-center" x-text="isPreStart ? (index + 4) : (index + 1)"></th>
                
                <td class="text-start">
                  <a :href="standing.account_url" x-text="standing.name" class="scoreboard-team-link"></a> 
                  <span x-show="standing.score === 0" class="badge bg-secondary ms-2" style="font-size: 0.6em; opacity: 0.7;">REGISTERED</span>
                </td>
                <td class="text-center" x-text="standing.score"></td>
              </tr>
            </template>
          </tbody>
        </table>
      </div>
    </div>
  </div>
  
  <div class="col-md-12" x-show="loading">
      <div class="text-center py-5">
          <i class="fas fa-circle-notch fa-spin fa-3x fa-fw spinner text-white"></i>
      </div>
  </div>

</div>
{% endblock %}

{% block scripts %}
  {{ Assets.js("assets/js/scoreboard.js") }}

  <script>
    document.addEventListener('alpine:init', () => {
        Alpine.data('CustomScoreboard', () => ({
            standings: [],
            loading: true,
            isPreStart: false,

            async init() {
                this.loading = true;
                try {
                    // 1. Ambil Scoreboard Asli (Yang punya skor)
                    const scoreResponse = await fetch('/api/v1/scoreboard');
                    const scoreResult = await scoreResponse.json();
                    let scoreboardData = scoreResult.data || [];

                    // 2. Ambil SEMUA Tim yang daftar
                    const userMode = window.CTFd?.config?.userMode || 'teams'; 
                    const endpoint = userMode === 'teams' ? '/api/v1/teams' : '/api/v1/users';
                    
                    const teamResponse = await fetch(endpoint);
                    const teamResult = await teamResponse.json();
                    let allTeams = teamResult.data || [];

                    // 3. Gabungkan Data (Merge)
                    // Kita cari tim mana yang SUDAH ada di scoreboard
                    // Tim yang BELUM ada, kita tambahkan dengan skor 0
                    
                    // Buat Set ID tim yang sudah ada di scoreboard biar gampang ngeceknya
                    const scoreboardIds = new Set(scoreboardData.map(item => item.id || item.account_id));

                    let zeroScoreTeams = [];
                    
                    allTeams.forEach(team => {
                        if (!scoreboardIds.has(team.id)) {
                            // Tim ini belum punya skor, buatkan data dummy
                            zeroScoreTeams.push({
                                pos: 0, // Posisi nanti diatur ulang
                                id: team.id,
                                account_id: team.id,
                                name: team.name,
                                score: 0,
                                account_url: `${userMode === 'teams' ? '/teams' : '/users'}/${team.id}`
                            });
                        }
                    });

                    // Sortir tim skor 0 berdasarkan ID (Pendaftar awal duluan)
                    zeroScoreTeams.sort((a, b) => a.id - b.id);

                    // Gabungkan: Scoreboard Asli (Atas) + Tim Skor 0 (Bawah)
                    let combinedStandings = [...scoreboardData, ...zeroScoreTeams];

                    // Recalculate 'pos' (ranking)
                    combinedStandings = combinedStandings.map((item, index) => {
                        item.pos = index + 1;
                        return item;
                    });

                    this.standings = combinedStandings;

                    // 4. Tentukan Mode: PreStart atau Normal?
                    // Kalau scoreboardData kosong (artinya belum ada yang submit flag), maka PreStart
                    if (scoreboardData.length === 0) {
                        this.isPreStart = true;
                    } else {
                        this.isPreStart = false;
                    }

                } catch (e) {
                    console.error("Error fetching scoreboard:", e);
                } finally {
                    this.loading = false;
                    setTimeout(() => {
                        window.dispatchEvent(new CustomEvent('bracket-change', { detail: null }));
                    }, 500);
                }
            }
        }));
    });
  </script>
{% endblock %}