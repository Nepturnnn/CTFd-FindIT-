{% extends "base.html" %}

{% block content %}
<div class="jumbotron">
  <div class="container text-center">
    <h1>{% trans %}Scoreboard{% endtrans %}</h1>
  </div>
</div>

<div class="container" x-data="CustomScoreboard">
  {% include "components/errors.html" %}

  <div class="row mb-4" x-show="isPreStart" x-transition>
    <div class="col-md-12 text-center">
      <div class="alert alert-info p-3" style="background: rgba(0, 255, 255, 0.1); border: 1px solid #181bca; border-radius: 15px;">
        <i class="fas fa-info-circle me-2"></i> Competition hasn't started.
      </div>
    </div>
  </div>

  <div id="score-graph" class="row d-flex align-items-center mb-4" x-data="ScoreboardDetail" x-ref="scoregraph" @bracket-change.window="activeBracket=$event.detail; update();">
    <div class="col-md-12 text-center">
      <i class="fas fa-circle-notch fa-spin fa-3x fa-fw spinner"></i>
    </div>
  </div>

  <div id="scoreboard" class="row">
    <div class="col-md-12">
      
      <div class="podium-flex-wrapper" x-show="isPreStart">
          
          <div class="podium-item second-place">
            <div class="podium-card">
              <div class="rank-badge">2</div>
              <div class="avatar-placeholder medal-silver">
                  <i class="fas fa-medal"></i>
              </div>
              <h4 class="text-muted mt-2">---</h4>
              <p class="points">0 pts</p>
            </div>
          </div>

          <div class="podium-item first-place">
            <div class="podium-card">
              <div class="rank-badge">1</div>
              <div class="avatar-placeholder medal-gold">
                  <i class="fas fa-trophy"></i>
              </div>
              <h4 class="text-muted mt-2">---</h4>
              <p class="points">0 pts</p>
            </div>
          </div>

          <div class="podium-item third-place">
            <div class="podium-card">
              <div class="rank-badge">3</div>
              <div class="avatar-placeholder medal-bronze">
                  <i class="fas fa-medal"></i>
              </div>
              <h4 class="text-muted mt-2">---</h4>
              <p class="points">0 pts</p>
            </div>
          </div>
      </div>

      <div class="podium-flex-wrapper" x-show="!isPreStart && standings.length > 0">
        <template x-if="standings.length >= 2">
          <div class="podium-item second-place">
            <div class="podium-card">
              <div class="rank-badge">2</div>
              <div class="avatar-placeholder medal-silver"><i class="fas fa-medal"></i></div>
              <h4 x-text="standings[1].name" class="text-truncate" style="max-width: 150px;"></h4>
              <p class="points" x-text="standings[1].score + ' pts'"></p>
            </div>
          </div>
        </template>
        <template x-if="standings.length >= 3">
          <div class="podium-item third-place">
            <div class="podium-card">
              <div class="rank-badge">3</div>
              <div class="avatar-placeholder medal-bronze"><i class="fas fa-medal"></i></div>
              <h4 x-text="standings[2].name" class="text-truncate" style="max-width: 150px;"></h4>
              <p class="points" x-text="standings[2].score + ' pts'"></p>
            </div>
          </div>
        </template>
      </div>

    </div>

    <div class="col-md-12" x-show="standings.length > 0">
      <div class="table-responsive">
        <table class="table table-striped table-hover">
          <thead>
            <tr>
              <th class="text-center" style="width: 80px">Rank</th>
              <th class="text-start">Team / User</th>
              <th class="text-center" style="width: 150px">Score</th>
            </tr>
          </thead>
          <tbody>
            <template x-for="(standing, index) in standings" :key="index">
              
              <tr x-show="isPreStart || index >= 3">
                <th class="text-center" x-text="isPreStart ? (index + 4) : (index + 1)"></th>
                
                <td class="text-start">
                  <a :href="standing.account_url" x-text="standing.name" class="text-decoration-none text-white fw-bold"></a>
                  <span x-show="isPreStart" class="badge bg-secondary ms-2" style="font-size: 0.6em; opacity: 0.7;">CHALLENGER</span>
                </td>
                <td class="text-center" x-text="standing.score"></td>
              </tr>

            </template>
          </tbody>
        </table>
      </div>
    </div>
    
    <div class="col-md-12" x-show="loading">
        <div class="text-center py-5">
            <i class="fas fa-circle-notch fa-spin fa-3x fa-fw spinner text-white"></i>
        </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
  {{ Assets.js("assets/js/scoreboard.js") }}

  <script>
    document.addEventListener('alpine:init', () => {
        Alpine.data('CustomScoreboard', () => ({
            standings: [],
            loading: true,
            isPreStart: false,

            async init() {
                this.loading = true;
                
                try {
                    // 1. Cek Scoreboard Asli
                    const response = await fetch('/api/v1/scoreboard');
                    const result = await response.json();
                    
                    if (result.data && result.data.length > 0) {
                        this.standings = result.data;
                        this.isPreStart = false;
                    } else {
                        // 2. Kalo Kosong -> Mode PreStart
                        this.isPreStart = true;

                        const userMode = window.CTFd?.config?.userMode || 'teams'; 
                        const endpoint = userMode === 'teams' ? '/api/v1/teams' : '/api/v1/users';

                        const teamResponse = await fetch(endpoint);
                        const teamResult = await teamResponse.json();

                        if (teamResult.data) {
                            // Sortir berdasarkan ID (Siapa daftar duluan)
                            let registeredTeams = teamResult.data.sort((a, b) => a.id - b.id);

                            this.standings = registeredTeams.map((team, index) => ({
                                pos: index + 1,
                                id: team.id,
                                name: team.name,
                                score: 0, 
                                account_url: `${userMode === 'teams' ? '/teams' : '/users'}/${team.id}`
                            }));
                        }
                    }
                } catch (e) {
                    console.error("Error fetching scoreboard:", e);
                } finally {
                    this.loading = false;
                    // Trigger graph update biar gak hilang
                    setTimeout(() => {
                        window.dispatchEvent(new CustomEvent('bracket-change', { detail: null }));
                    }, 500);
                }
            }
        }));
    });
  </script>
{% endblock %}